<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ðŸ” Admin guard -->
  <script>
    if (!localStorage.getItem("adminToken")) {
      window.location.href = "/admin-login.html";
    }
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€“ Player Scores</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }

  h1 {
    text-align: center;
  }

  h2 {
    margin-top: 30px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
  }

  .player {
    background: #fff;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 5px;
    display: grid;
    grid-template-columns: 1.5fr repeat(5, 1fr);
    gap: 5px;
    align-items: center;
  }

  .player-name {
    font-weight: bold;
    font-size: 14px;
  }

  input {
    width: 100%;
    padding: 5px;
    text-align: center;
  }

  .total {
    font-weight: bold;
    text-align: center;
  }

  /* MAIN SAVE BUTTON */
  button {
    margin-top: 25px;
    width: 100%;
    padding: 14px;
    font-size: 18px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  /* HEADER ROW */
  .player.header {
    background: transparent;
    font-weight: bold;
    border-bottom: 2px solid #999;
  }

  .player.header div {
    text-align: center;
  }

  .player.header div:first-child {
    text-align: left;
  }

  /* LOCKED INPUTS */
  .locked {
    background: #eee !important;
    color: #666;
    cursor: not-allowed;
  }

  /* SMALL LOCK BUTTONS IN HEADER */
  .player.header button {
    margin-top: 6px;
    width: auto;
    padding: 4px 8px;
    font-size: 12px;
    background: #6c757d;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
</style>

</head>

<body>

<h1>Admin â€“ Player Scores</h1>

<div id="scores">Loading playersâ€¦</div>

<button id="saveBtn">Save Scores</button>

<script>
  const container = document.getElementById('scores');
  const saveBtn = document.getElementById('saveBtn');
  const token = localStorage.getItem("adminToken");

  let players = [];

  // ðŸ” Load players WITH auth
  fetch('/api/admin/player-scores', {
    headers: {
      "Authorization": token
    }
  })
    .then(res => {
      if (!res.ok) throw new Error("Unauthorized");
      return res.json();
    })
    .then(data => {
      players = data;
      render();
    })
    .catch(() => {
      alert("Admin session expired. Please log in again.");
      localStorage.removeItem("adminToken");
      window.location.href = "/admin-login.html";
    });

  function render() {
    container.innerHTML = '';

    // HEADER ROW
    const header = document.createElement('div');
    header.className = 'player header';
    header.innerHTML = `
      <div>Player</div>
      <div>
    Wildcard<br>
    <button onclick="toggleLock('wildcard')">ðŸ”’ Lock</button>
  </div>

  <div>
    Divisional<br>
    <button onclick="toggleLock('divisional')">ðŸ”’ Lock</button>
  </div>

  <div>
    Conference<br>
    <button onclick="toggleLock('conference')">ðŸ”’ Lock</button>
  </div>

  <div>
    Super Bowl<br>
    <button onclick="toggleLock('superbowl')">ðŸ”’ Lock</button>
  </div>
      <div>Total</div>
    `;
    container.appendChild(header);

    const grouped = {};
    players.forEach(p => {
      if (!grouped[p.position]) grouped[p.position] = [];
      grouped[p.position].push(p);
    });

    ['QB','RB','WR','TE','K'].forEach(pos => {
      if (!grouped[pos]) return;

      const h = document.createElement('h2');
      h.textContent = pos;
      container.appendChild(h);

      grouped[pos].forEach(p => {
        const row = document.createElement('div');
        row.className = 'player';
        row.dataset.id = p.player_id;

        row.innerHTML = `
          <div class="player-name">${p.player_name} (${p.team})</div>
          <input type="number" value="${p.wildcard}" data-field="wildcard">
          <input type="number" value="${p.divisional}" data-field="divisional">
          <input type="number" value="${p.conference}" data-field="conference">
          <input type="number" value="${p.superbowl}" data-field="superbowl">
          <div class="total">0</div>
        `;

        row.querySelectorAll('input').forEach(inp => {
          inp.addEventListener('input', () => updateTotal(row));
        });

        updateTotal(row);
        container.appendChild(row);
      });
    });
    applyLocksOnLoad();
}

  function updateTotal(row) {
    const total =
      Number(row.querySelector('[data-field="wildcard"]').value || 0) +
      Number(row.querySelector('[data-field="divisional"]').value || 0) +
      Number(row.querySelector('[data-field="conference"]').value || 0) +
      Number(row.querySelector('[data-field="superbowl"]').value || 0);

    row.querySelector('.total').textContent = total.toFixed(2);

  }

  // ðŸ” Save scores WITH auth
  saveBtn.addEventListener('click', async () => {
    const rows = document.querySelectorAll('.player:not(.header)');

    for (const row of rows) {
      const payload = {
        player_id: row.dataset.id,
        wildcard: Number(row.querySelector('[data-field="wildcard"]').value || 0),
        divisional: Number(row.querySelector('[data-field="divisional"]').value || 0),
        conference: Number(row.querySelector('[data-field="conference"]').value || 0),
        superbowl: Number(row.querySelector('[data-field="superbowl"]').value || 0)
      };

      const res = await fetch('/api/admin/player-scores', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        alert("Failed to save scores. Admin session expired.");
        localStorage.removeItem("adminToken");
        window.location.href = "/admin-login.html";
        return;
      }
    }

    alert('Scores saved successfully');
  });
const lockedColumns = JSON.parse(
  localStorage.getItem("lockedColumns")
) || {
  wildcard: false,
  divisional: false,
  conference: false,
  superbowl: false
};

function toggleLock(field) {
  lockedColumns[field] = !lockedColumns[field];

  // Save lock state
  localStorage.setItem("lockedColumns", JSON.stringify(lockedColumns));

  document.querySelectorAll(`input[data-field="${field}"]`)
    .forEach(input => {
      input.disabled = lockedColumns[field];
      input.classList.toggle("locked", lockedColumns[field]);
    });

  document
    .querySelectorAll(`button[onclick="toggleLock('${field}')"]`)
    .forEach(btn => {
      btn.textContent = lockedColumns[field] ? "ðŸ”“ Unlock" : "ðŸ”’ Lock";
    });
}
function applyLocksOnLoad() {
  Object.keys(lockedColumns).forEach(field => {
    if (lockedColumns[field]) {
      document
        .querySelectorAll(`input[data-field="${field}"]`)
        .forEach(input => {
          input.disabled = true;
          input.classList.add("locked");
        });

      document
        .querySelectorAll(`button[onclick="toggleLock('${field}')"]`)
        .forEach(btn => {
          btn.textContent = "ðŸ”“ Unlock";
        });
    }
  });
}

</script>

</body>
</html>
